---
phase: 01-fork-brand-deploy
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - raincal-fork/.env
  - raincal-fork/yarn.lock
autonomous: true

must_haves:
  truths:
    - "Developer can run RainCal locally"
    - "Database migrations execute successfully"
    - "Development server starts without errors"
  artifacts:
    - path: "raincal-fork/.env"
      provides: "Local environment configuration"
      min_lines: 20
    - path: "raincal-fork/node_modules"
      provides: "Installed dependencies"
  key_links:
    - from: "raincal application"
      to: "local PostgreSQL database"
      via: "DATABASE_URL in .env"
      pattern: "postgresql://.*localhost"
---

<objective>
Configure local development environment with Node.js, PostgreSQL, dependencies, and environment variables.

Purpose: Establishes working local development environment for testing branding changes before deployment. Validates that fork works identically to upstream Cal.com.

Output: Running local Cal.com instance at localhost:3000 with database migrations applied.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/research/STACK.md
@.planning/research/PITFALLS.md

# Stack requirements
Cal.com requires: Node 18.x, PostgreSQL 13+, Yarn 4.x package manager. Research confirms these are mandatory, no alternatives supported.

# Pitfall awareness
PITFALL-01: Never modify Prisma schema without migrations
PITFALL-03: Environment variable configuration must be precise (NEXT_PUBLIC_WEBAPP_URL, NEXTAUTH_URL, ALLOWED_HOSTNAMES)
</context>

<tasks>

<task type="auto">
  <name>Install system dependencies and create database</name>
  <files>N/A (system-level)</files>
  <action>
    Verify and install required system dependencies:

    1. Check Node version: `node --version` (should be 18.x or 20.x)
       - If not installed or wrong version: `brew install node@18` (macOS)

    2. Check PostgreSQL: `psql --version` (should be 13.x or higher)
       - If not installed: `brew install postgresql@15` (macOS)
       - Start PostgreSQL: `brew services start postgresql@15`

    3. Check Yarn: `yarn --version` (should be 4.x)
       - If not installed or wrong version: `corepack enable` then `corepack prepare yarn@4.12.0 --activate`

    4. Create PostgreSQL database:
       ```bash
       createdb raincal_dev
       ```

    Why these versions: Cal.com's package.json specifies Node 18+, PostgreSQL 13+, Yarn 4.x. Using lower versions causes build failures.
    Why local database: Testing environment setup before production deployment prevents database migration issues.
  </action>
  <verify>
    1. `node --version` shows v18.x or v20.x
    2. `psql --version` shows 13.x or higher
    3. `yarn --version` shows 4.x
    4. `psql -l | grep raincal_dev` shows database exists
  </verify>
  <done>Node 18+, PostgreSQL 13+, Yarn 4.x installed; raincal_dev database created</done>
</task>

<task type="auto">
  <name>Configure environment variables for local development</name>
  <files>raincal-fork/.env</files>
  <action>
    Navigate to fork: `cd /Users/ali/Documents/Projects/raincal-fork`

    Copy example environment file and configure for local development:

    ```bash
    cp .env.example .env
    ```

    Edit `.env` with local development values (addresses PITFALL-03):

    ```bash
    # Database (local PostgreSQL)
    DATABASE_URL="postgresql://ali@localhost:5432/raincal_dev"

    # Core application (localhost for development)
    NEXT_PUBLIC_WEBAPP_URL="http://localhost:3000"
    NEXTAUTH_URL="http://localhost:3000/api/auth"
    ALLOWED_HOSTNAMES='"localhost"'

    # Secrets (generate random values)
    NEXTAUTH_SECRET=$(openssl rand -base64 32)
    CALENDSO_ENCRYPTION_KEY=$(openssl rand -base64 32)

    # Disable features not needed for local dev
    NEXT_PUBLIC_DISABLE_SIGNUP=false  # Allow creating first user
    NEXT_PUBLIC_LICENSE_CONSENT=true

    # Email (optional for local dev, can skip)
    # EMAIL_FROM="dev@localhost"
    # EMAIL_SERVER_HOST="localhost"
    # EMAIL_SERVER_PORT=1025

    # Branding (keep Cal.com defaults for now, will customize in Plan 03)
    NEXT_PUBLIC_APP_NAME="Cal.com"
    NEXT_PUBLIC_COMPANY_NAME="Cal.com, Inc."
    ```

    Critical variables explanation (from PITFALL-03):
    - NEXT_PUBLIC_WEBAPP_URL: Where users access the app
    - NEXTAUTH_URL: Authentication endpoint (must match WEBAPP_URL + /api/auth)
    - ALLOWED_HOSTNAMES: Comma-separated hostnames (must include WEBAPP_URL hostname)
    - All three must align precisely or get 404s and authentication loops

    Why keep Cal.com branding now: Validates that environment setup works before applying customizations. Branding changes in Plan 03.
  </action>
  <verify>
    1. `.env` file exists in raincal-fork directory
    2. `grep "DATABASE_URL" .env` shows postgresql connection string
    3. `grep "NEXTAUTH_SECRET" .env` shows non-empty value
    4. `grep "NEXT_PUBLIC_WEBAPP_URL" .env` shows http://localhost:3000
  </verify>
  <done>Local .env configured with database connection, authentication secrets, and localhost URLs</done>
</task>

<task type="auto">
  <name>Install dependencies, run migrations, start development server</name>
  <files>raincal-fork/yarn.lock, raincal-fork/node_modules</files>
  <action>
    In `/Users/ali/Documents/Projects/raincal-fork` directory:

    1. Install dependencies (this takes 5-10 minutes):
       ```bash
       yarn install
       ```

    2. Generate Prisma client:
       ```bash
       yarn workspace @calcom/prisma generate
       ```

    3. Run database migrations (addresses PITFALL-01):
       ```bash
       yarn workspace @calcom/prisma db-migrate-dev
       ```

       This creates all tables (User, Team, EventType, Booking, Attendee, etc.) in raincal_dev database.

       CRITICAL: NEVER edit packages/prisma/schema.prisma without running this migration command. Direct schema edits cause data loss in production (PITFALL-01).

    4. Start development server:
       ```bash
       yarn dev
       ```

       Server should start on http://localhost:3000. Watch for any startup errors.

    Expected behavior:
    - First build takes 5-10 minutes (Next.js compilation)
    - Console shows "ready - started server on 0.0.0.0:3000"
    - No errors about missing environment variables
    - No database connection errors

    If build runs out of memory: Set `export NODE_OPTIONS="--max-old-space-size=8192"` before running yarn dev.
  </action>
  <verify>
    1. `yarn install` completes without errors
    2. `yarn workspace @calcom/prisma generate` succeeds
    3. Database migrations apply successfully
    4. Development server starts and shows "ready" message
    5. Visit http://localhost:3000 in browser and see Cal.com homepage (not 404)
    6. Check console for errors - should be minimal/none
  </verify>
  <done>Dependencies installed, database migrated, development server running at localhost:3000</done>
</task>

</tasks>

<verification>
1. System has Node 18+, PostgreSQL 13+, Yarn 4.x installed
2. Local database raincal_dev exists with Cal.com schema migrated
3. .env file configured with correct localhost URLs and secrets
4. Dependencies installed (node_modules populated)
5. Development server accessible at http://localhost:3000
6. Can view Cal.com homepage without errors
7. No environment variable mismatch warnings in console
</verification>

<success_criteria>
- Local Cal.com instance runs successfully on localhost:3000
- Database migrations complete without errors
- Homepage loads without 404 or authentication errors
- Environment variables properly configured (no localhost redirect bugs)
- Ready for branding customization in next plan
</success_criteria>

<output>
After completion, create `.planning/phases/01-fork-brand-deploy/01-02-SUMMARY.md`
</output>
